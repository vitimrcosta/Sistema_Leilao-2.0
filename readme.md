# üèÜ Sistema de Leil√µes

Um sistema completo de leil√µes desenvolvido em Python com SQLAlchemy, implementando todas as regras de neg√≥cio necess√°rias para gerenciar leil√µes online de forma segura e eficiente.

## üìã √çndice

- [Caracter√≠sticas](#-caracter√≠sticas)
- [Tecnologias](#-tecnologias)
- [Estrutura do Projeto](#-estrutura-do-projeto)
- [Instala√ß√£o](#-instala√ß√£o)
- [Uso](#-uso)
- [Regras de Neg√≥cio](#-regras-de-neg√≥cio)
- [API/Servi√ßos](#-apiservi√ßos)
- [Modelos de Dados](#-modelos-de-dados)
- [Valida√ß√µes](#-valida√ß√µes)
- [Contribui√ß√£o](#-contribui√ß√£o)
- [Licen√ßa](#-licen√ßa)

## üöÄ Caracter√≠sticas

- **Gest√£o Completa de Participantes**: Cadastro, valida√ß√£o e gerenciamento de participantes
- **Sistema de Leil√µes**: Cria√ß√£o, atualiza√ß√£o e controle de status autom√°tico
- **Sistema de Lances**: Valida√ß√£o rigorosa de lances com regras de neg√≥cio
- **Notifica√ß√µes por Email**: Sistema autom√°tico de notifica√ß√£o para vencedores
- **Estados Autom√°ticos**: Controle autom√°tico de estados dos leil√µes (INATIVO ‚Üí ABERTO ‚Üí FINALIZADO/EXPIRADO)
- **Valida√ß√µes Robustas**: Valida√ß√£o de CPF, email, datas e valores

## üõ† Tecnologias

- **Python 3.8+**
- **SQLAlchemy**: ORM para gerenciamento do banco de dados
- **SQLite**: Banco de dados (configur√°vel para outros SGBDs)
- **email-validator**: Valida√ß√£o de emails
- **SMTP**: Sistema de envio de emails
- **pytest**: Framework de testes
- **pytest-cov**: Cobertura de testes

## üìÅ Estrutura do Projeto

```
src/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ models.py           # Modelos SQLAlchemy (Participante, Leilao, Lance)
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ database.py         # Configura√ß√£o do banco de dados
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ participante_service.py  # L√≥gica de neg√≥cio para participantes
‚îÇ   ‚îú‚îÄ‚îÄ leilao_service.py       # L√≥gica de neg√≥cio para leil√µes
‚îÇ   ‚îú‚îÄ‚îÄ lance_service.py        # L√≥gica de neg√≥cio para lances
‚îÇ   ‚îî‚îÄ‚îÄ email_service.py        # Sistema de notifica√ß√µes por email
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ validators.py       # Validadores e regras de valida√ß√£o

tests/
‚îú‚îÄ‚îÄ conftest.py                    # Configura√ß√µes e fixtures para testes
‚îú‚îÄ‚îÄ test_participante_service.py   # Testes unit√°rios do ParticipanteService
‚îú‚îÄ‚îÄ test_leilao_service.py        # Testes unit√°rios do LeilaoService
‚îú‚îÄ‚îÄ test_lance_service.py         # Testes unit√°rios do LanceService
‚îú‚îÄ‚îÄ test_email_service.py         # Testes unit√°rios do EmailService
‚îî‚îÄ‚îÄ integration/                  # Testes de integra√ß√£o
    ‚îú‚îÄ‚îÄ test_integration.py       # Testes de integra√ß√£o gerais
    ‚îú‚îÄ‚îÄ test_lance_integration.py # Testes de integra√ß√£o de lances
    ‚îî‚îÄ‚îÄ test_participante_integration.py # Testes integra√ß√£o participantes
```

## üîß Instala√ß√£o

1. **Clone o reposit√≥rio**
```bash
git clone https://github.com/seu-usuario/sistema-leiloes.git
cd sistema-leiloes
```

2. **Crie um ambiente virtual**
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ou
venv\Scripts\activate     # Windows
```

3. **Instale as depend√™ncias**
```bash
pip install sqlalchemy email-validator pytest
```

4. **Configure o banco de dados**
```python
from src.repositories.database import db_config

# Criar as tabelas
db_config.create_tables()
```

5. **Execute os testes**
```bash
# Executar todos os testes
pytest

# Executar testes com detalhes
pytest -v

# Executar testes de um m√≥dulo espec√≠fico
pytest tests/test_lance_service.py -v

# Executar com coverage
pytest --cov=src
```

## üí° Uso

### Exemplo B√°sico

```python
from datetime import datetime, timedelta
from src.services import ParticipanteService, LeilaoService, LanceService

# Inicializar servi√ßos
participante_service = ParticipanteService()
leilao_service = LeilaoService()
lance_service = LanceService()

# Criar participante
participante = participante_service.criar_participante(
    cpf="12345678901",
    nome="Jo√£o Silva",
    email="joao@email.com",
    data_nascimento=datetime(1990, 1, 1)
)

# Criar leil√£o
leilao = leilao_service.criar_leilao(
    nome="iPhone 15 Pro",
    lance_minimo=1000.0,
    data_inicio=datetime.now() + timedelta(minutes=5),
    data_termino=datetime.now() + timedelta(hours=24)
)

# Atualizar status dos leil√µes (INATIVO ‚Üí ABERTO quando chegar a hora)
leilao_service.atualizar_status_leiloes()

# Criar lance
lance = lance_service.criar_lance(
    participante_id=participante.id,
    leilao_id=leilao.id,
    valor=1100.0
)
```

## üìú Regras de Neg√≥cio

### **Participantes**
- ‚úÖ Participantes devem ter pelo menos 18 anos
- ‚úÖ CPF √∫nico e v√°lido (11 d√≠gitos num√©ricos)
- ‚úÖ Email √∫nico e v√°lido
- ‚ö†Ô∏è Participantes com lances n√£o podem ser alterados/exclu√≠dos

### **Leil√µes**
- ‚úÖ Quatro estados: `INATIVO`, `ABERTO`, `FINALIZADO`, `EXPIRADO`
- ‚úÖ Transi√ß√µes autom√°ticas baseadas em data/hora
- ‚úÖ Apenas leil√µes `INATIVOS` podem ser alterados/exclu√≠dos
- ‚úÖ Data de t√©rmino deve ser posterior √† data de in√≠cio
- ‚úÖ Lance m√≠nimo obrigat√≥rio e > 0

### **Lances**
- ‚úÖ Apenas em leil√µes `ABERTOS`
- ‚úÖ Participante deve estar cadastrado
- ‚úÖ Lance deve ser ‚â• lance m√≠nimo
- ‚úÖ Lance deve ser maior que o √∫ltimo lance
- ‚ö†Ô∏è Mesmo participante n√£o pode dar dois lances consecutivos
- ‚ùå Lances n√£o podem ser alterados ap√≥s cria√ß√£o

### **Notifica√ß√µes**
- üìß Vencedores recebem email autom√°tico
- üèÜ Sistema identifica vencedor automaticamente (maior lance)

## üîå API/Servi√ßos

### ParticipanteService

```python
# Criar participante
participante = participante_service.criar_participante(cpf, nome, email, data_nascimento)

# Listar participantes
participantes = participante_service.listar_participantes(nome_parcial="Jo√£o")

# Obter estat√≠sticas
stats = participante_service.obter_estatisticas_participante(participante_id)
```

### LeilaoService

```python
# Criar leil√£o
leilao = leilao_service.criar_leilao(nome, lance_minimo, data_inicio, data_termino)

# Atualizar status automaticamente
resultado = leilao_service.atualizar_status_leiloes(enviar_emails=True)

# Listar leil√µes por status
leiloes_abertos = leilao_service.listar_leiloes(status=StatusLeilao.ABERTO)
```

### LanceService

```python
# Criar lance
lance = lance_service.criar_lance(participante_id, leilao_id, valor)

# Obter lances de um leil√£o (ordem crescente)
lances = lance_service.obter_lances_leilao(leilao_id, ordem_crescente=True)

# Verificar se pode dar lance
pode, motivo = lance_service.verificar_pode_dar_lance(participante_id, leilao_id)

# Obter ranking dos participantes
ranking = lance_service.obter_ranking_participantes_leilao(leilao_id)
```

### EmailService

```python
# Enviar email para vencedor
email_service = EmailService()
sucesso = email_service.enviar_email_vencedor(leilao, participante, valor_lance)

# Notificar todos os vencedores pendentes
resultado = email_service.notificar_vencedores_pendentes(leilao_service)
```

## üóÉ Modelos de Dados

### Participante
- **id**: Chave prim√°ria
- **cpf**: CPF √∫nico (11 d√≠gitos)
- **nome**: Nome completo
- **email**: Email √∫nico
- **data_nascimento**: Data de nascimento
- **data_cadastro**: Timestamp de cadastro

### Leilao
- **id**: Chave prim√°ria
- **nome**: Nome/descri√ß√£o do leil√£o
- **lance_minimo**: Valor m√≠nimo para lances
- **data_inicio**: Data/hora de in√≠cio
- **data_termino**: Data/hora de t√©rmino
- **status**: Estado atual (INATIVO/ABERTO/FINALIZADO/EXPIRADO)
- **participante_vencedor_id**: ID do vencedor (quando finalizado)

### Lance
- **id**: Chave prim√°ria
- **valor**: Valor do lance
- **data_lance**: Timestamp do lance
- **leilao_id**: Refer√™ncia ao leil√£o
- **participante_id**: Refer√™ncia ao participante

## ‚úÖ Valida√ß√µes

O sistema implementa valida√ß√µes robustas atrav√©s da classe `validators.py`:

### ValidadorParticipante
- **CPF**: Formato, 11 d√≠gitos, n√£o pode ser sequ√™ncia igual
- **Email**: Formato v√°lido usando `email-validator`
- **Nome**: M√≠nimo 2 caracteres
- **Idade**: M√≠nimo 18 anos

### ValidadorLeilao
- **Nome**: M√≠nimo 3 caracteres
- **Lance m√≠nimo**: N√∫mero positivo
- **Datas**: T√©rmino posterior ao in√≠cio, in√≠cio n√£o no passado

### ValidadorLance
- **Valor**: N√∫mero positivo obrigat√≥rio

## ü§ù Contribui√ß√£o

1. Fa√ßa um fork do projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. **Execute os testes** para garantir que tudo funciona:
   ```bash
   pytest -v
   ```
4. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
5. Push para a branch (`git push origin feature/AmazingFeature`)
6. Abra um Pull Request

### Diretrizes para Contribui√ß√£o

- **Cobertura de Testes**: Mantenha a cobertura acima de 95%
- **Documenta√ß√£o**: Documente novas funcionalidades
- **Regras de Neg√≥cio**: Respeite todas as regras implementadas
- **Testes de Integra√ß√£o**: Adicione testes de integra√ß√£o para novas features
- **Valida√ß√µes**: Implemente valida√ß√µes robustas para novos campos

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo `LICENSE` para mais detalhes.

---

## üß™ Testes

O projeto possui uma su√≠te completa de testes automatizados com **98%+ de cobertura**.

### Tipos de Testes

#### **Testes Unit√°rios**
- `test_participante_service.py`: Testa todas as funcionalidades do ParticipanteService
- `test_leilao_service.py`: Testa todas as funcionalidades do LeilaoService  
- `test_lance_service.py`: Testa todas as funcionalidades do LanceService
- `test_email_service.py`: Testa o sistema de notifica√ß√µes por email

#### **Testes de Integra√ß√£o**
- `integration/test_integration.py`: Testa cen√°rios completos do sistema
- `integration/test_lance_integration.py`: Testa fluxos completos de lances
- `integration/test_participante_integration.py`: Testa integra√ß√£o participante-leil√£o

### Executando os Testes

```bash
# Todos os testes
pytest

# Com informa√ß√µes detalhadas
pytest -v

# Com cobertura de c√≥digo
pytest --cov=src

# Apenas testes de um servi√ßo espec√≠fico
pytest tests/test_lance_service.py -v

# Apenas testes de integra√ß√£o
pytest tests/integration/ -v

# Teste espec√≠fico de integra√ß√£o
pytest tests/integration/test_lance_integration.py -v
```

### Fixtures e Configura√ß√£o

O sistema de testes utiliza fixtures avan√ßadas:

- **`clean_database`**: Banco de dados limpo para cada teste
- **`cenario_leilao_aberto`**: Cen√°rio completo com participantes e leil√£o aberto
- **`participante_valido`**: Participante v√°lido para testes
- **`leilao_valido`**: Leil√£o v√°lido para testes
- **`varios_leiloes`**: M√∫ltiplos leil√µes para testes de listagem

### Cen√°rios Testados

#### **Regras de Neg√≥cio**
- ‚úÖ Valida√ß√µes de idade, CPF e email
- ‚úÖ Transi√ß√µes de estados de leil√µes
- ‚úÖ Regras de lances consecutivos
- ‚úÖ Prote√ß√£o de dados com lances

#### **Integra√ß√£o Completa**
- ‚úÖ Ciclo completo de leil√£o (cria√ß√£o ‚Üí abertura ‚Üí finaliza√ß√£o)
- ‚úÖ M√∫ltiplos participantes em m√∫ltiplos leil√µes
- ‚úÖ Sistema de emails autom√°ticos
- ‚úÖ Relat√≥rios e estat√≠sticas

#### **Casos Extremos**
- ‚úÖ Leil√µes sem lances (expira√ß√£o)
- ‚úÖ Tentativas de viola√ß√£o de regras
- ‚úÖ Opera√ß√µes em leil√µes em diferentes estados
- ‚úÖ Valida√ß√µes de integridade de dados

---

## üîç Features Avan√ßadas

### Relat√≥rios Dispon√≠veis
- üìä Estat√≠sticas de leil√µes (total de lances, participantes √∫nicos)
- ü•á Ranking de participantes por leil√£o
- üìà Hist√≥rico completo de lances
- üí∞ Estat√≠sticas financeiras por participante

### Sistema de Estados
```
INATIVO ‚Üí ABERTO ‚Üí FINALIZADO (com lances)
    ‚Üì         ‚Üì
EXPIRADO ‚Üê EXPIRADO (sem lances)
```

### Simula√ß√£o de Lances
```python
# Simular lance antes de criar
resultado = lance_service.simular_lance(participante_id, leilao_id, valor)
if resultado['valido']:
    lance = lance_service.criar_lance(participante_id, leilao_id, valor)
```

---

**Desenvolvido com ‚ù§Ô∏è em Python**